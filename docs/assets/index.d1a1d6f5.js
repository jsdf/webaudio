var e=Object.defineProperty,t=Object.defineProperties,r=Object.getOwnPropertyDescriptors,n=Object.getOwnPropertySymbols,a=Object.prototype.hasOwnProperty,o=Object.prototype.propertyIsEnumerable,l=(t,r,n)=>r in t?e(t,r,{enumerable:!0,configurable:!0,writable:!0,value:n}):t[r]=n;import{r as s,R as i,a as c}from"./vendor.b1c20c04.js";function u(e,t){const r=Math.exp(e*t);return(r-1)/(r+1)}function m(e){return Math.sin(e*Math.PI)/2+.5}var p={linear:function(){for(var e,t=new Float32Array(256),r=0;r<256;++r)e=2*r/256-1,t[r]=e;return t},sine:function(){for(var e,t=new Float32Array(256),r=0;r<256;++r)t[r]=2*(e=r/256,-(Math.cos(Math.PI*e)-1)/2)-1;return t},cubic:function(){for(var e,t=new Float32Array(256),r=0;r<256;++r)t[r]=2*((e=r/256)<.5?4*e*e*e:1-Math.pow(-2*e+2,3)/2)-1;return t},sigmoid:function(){for(var e,t=new Float32Array(256),r=0;r<256;++r)e=2*r/256-1,t[r]=u(e,10);return t},sinefold:function(){for(var e,t=new Float32Array(256),r=0;r<256;++r)e=2*r/256-1,t[r]=2*m(e)-1;return t},hardclip:function(){for(var e,t=new Float32Array(256),r=0;r<256;++r)e=2*r/256-1,t[r]=1*(e>.8?.8:e<-.8?-.8:e)/.8;return t},rectify:function(){for(var e,t=new Float32Array(256),r=0;r<256;++r)e=2*r/256-1,t[r]=Math.abs(e);return t},halfrectify:function(){for(var e,t=new Float32Array(256),r=0;r<256;++r)e=2*r/256-1,t[r]=e<0?0:e;return t}};function d({audioContext:e,source:t}){const r=s.exports.useRef(null),n=s.exports.useRef(4);return s.exports.useEffect((()=>{const a=r.current;if(!a||!t)return;const o=e.createAnalyser();t.connect(o),o.fftSize=1024;var l=o.frequencyBinCount,s=new Float32Array(l);const i=a.getContext("2d");let c,u=0;return c=requestAnimationFrame((function e(){if(u++,0===n.current&&(i.clearRect(0,0,a.width,a.height),i.fillStyle="rgba(200, 200, 200, 1)",i.fillRect(0,0,a.width,a.height)),0!==n.current&&u%n.current==0){o.getFloatTimeDomainData(s),i.clearRect(0,0,a.width,a.height),i.fillStyle="rgba(200, 200, 200, 1)",i.fillRect(0,0,a.width,a.height),i.lineWidth=2,i.strokeStyle="rgb(0, 0, 0)",i.beginPath();let e=1*a.width/l,t=0;for(let r=0;r<l;r++){let n=s[r]+1,o=a.height-n*a.height/2;0===r?i.moveTo(t,o):i.lineTo(t,o),t+=e}i.lineTo(a.width,a.height/2),i.stroke()}c=requestAnimationFrame(e)})),()=>{cancelAnimationFrame(c)}}),[e,t]),i.createElement("canvas",{width:800,height:400,ref:r,style:{cursor:"pointer"},onClick:()=>{n.current=4===n.current?0:4}})}function h({data:e,width:t,height:r}){const n=s.exports.useRef(null);return s.exports.useEffect((()=>{const t=n.current;if(!t)return;const r=t.getContext("2d");r.clearRect(0,0,t.width,t.height),r.fillStyle="rgb(200, 200, 200)",r.fillRect(0,0,t.width,t.height),r.lineWidth=2,r.strokeStyle="rgb(0, 0, 0)",r.beginPath();let a=1*t.width/e.length,o=0;for(let n=0;n<e.length;n++){let l=(1-(e[n]+1)/2)*t.height;0===n?r.moveTo(o,l):r.lineTo(o,l),o+=a}r.stroke()}),[e]),i.createElement("canvas",{width:t,height:r,ref:n})}class f extends AudioWorkletNode{constructor(e){super(e,"tremolo-processor")}static load(e){return e.audioWorklet.addModule("tremoloProcessor.js")}}class g extends AudioWorkletNode{constructor(e,t,r){super(e,t,r);var n=this;this.port.onmessage=function(e){var t=e.data;try{t=JSON.parse(t)}catch(r){}t&&("descriptor"==t.type&&(n.descriptor=t.data),n.onmessage(t))}}setParam(e,t){this.port.postMessage({type:"param",key:e,value:t})}setPatch(e){this.port.postMessage({type:"patch",data:e})}setSysex(e){this.port.postMessage({type:"sysex",data:e})}onMidi(e){this.port.postMessage({type:"midi",data:e})}set midiIn(e){this._midiInPort&&(this._midiInPort.close(),this._midiInPort.onmidimessage=null),this._midiInPort=e,this._midiInPort.onmidimessage=function(e){this.port.postMessage({type:"midi",data:e.data})}.bind(this)}sendMessage(e,t,r){this.port.postMessage({type:"msg",verb:e,prop:t,data:r})}get gui(){return null}onmessage(e){}getState(){return Promise.resolve(null)}setState(e){return Promise.resolve()}}const v={Dry:1,Wet:.5,PreDelay:0,Size:.5,Diffusion:1,Decay:.5,InputHighDamp:1,InputLowDamp:1,ReverbHighDamp:1,ReverbLowDamp:1},y={};["Dry","Wet","PreDelay","InputLowDamp","InputHighDamp","Size","Diffusion","Decay","ReverbHighDamp","ReverbLowDamp","ModSpeed","ModShape","ModDepth","Freeze","Clear","FreezeToggle","ClearToggle","DryCv","WetCv","InputLowDampCv","InputHighDampCv","SizeCv","DiffusionCv","DecayCv","ReverbHighDampCv","ReverbLowDampCv","ModSpeedCv","ModShapeCv","ModDepthCv","TunedMode","DiffuseInput"].forEach(((e,t)=>{y[e]=t}));class x extends g{constructor(e,t){(t=t||{}).numberOfInputs=1,t.numberOfOutputs=1,t.inputChannelCount=[2],t.outputChannelCount=[2],super(e,"Platverb",t)}setNamedParam(e,t){this.setParam(y[e],t)}static getParamDefaults(){return v}static load(e){return e.audioWorklet.addModule("wasm/compiled/PlatverbModule.js")}}function b({audioContext:e,source:t,scale:r}){const n=s.exports.useRef(null),a=s.exports.useRef({cursor:0,values:new Array(10).fill(0)});return s.exports.useEffect((()=>{const o=n.current;if(!o||!t)return;const l=e.createAnalyser();t.connect(l),l.fftSize=2048;var s=l.frequencyBinCount,i=new Float32Array(s);const c=o.getContext("2d");let u,m=0;return u=requestAnimationFrame((function e(){if(m++,m%1==0){l.getFloatTimeDomainData(i),c.fillStyle="rgba(200, 200, 200, 0.6)",c.fillRect(0,0,o.width,o.height);let e=0;for(let r=0;r<s;r++){let t=i[r];e=Math.max(Math.abs(t))}a.current.values[a.current.cursor]=e,a.current.cursor++,a.current.cursor=a.current.cursor%10;const t=a.current.values.reduce(((e,t)=>e+t))/10,n=t*r;c.fillStyle=t<1?"rgb(0, 0, 0)":"rgb(200, 0, 0)",c.fillRect(0,o.height-o.height*n,o.width,o.height*n),c.stroke()}u=requestAnimationFrame(e)})),()=>{cancelAnimationFrame(u)}}),[e,t,r]),i.createElement("canvas",{width:40,height:230,ref:n})}function E(e,t,r,n,a){const o=a*(1/r);return e*(l=-1,s=1,i=Math.sin(t/o*Math.PI*2),c=1-n,u=1,i<l?c:i>s?u:c+(i-l)/(s-l)*(u-c));var l,s,i,c,u}let w=parseInt(new URLSearchParams(window.location.search).get("d"));isNaN(w)&&(w=4);const C=new AudioContext;function M(e){const t=C.createMediaElementSource(e),r=C.createGain(),n=1!=w&&w<4?null:function(){const e=C.createWaveShaper();return e.curve=p.sigmoid(),e.oversample="4x",e}(),a=2!=w&&w<4?null:new f(C),o=3!=w&&w<4?null:new x(C),l=C.createGain(),s=[t,r,n,a,o,l,C.destination].filter(Boolean);for(let i=0;i<s.length-1;i++)s[i].connect(s[i+1]);return{track:t,pregain:r,distortion:n,tremolo:a,reverb:o,postgain:l}}function S({name:e,min:t,max:r,step:n,steps:a,value:o,onChange:l}){return i.createElement("label",null,e,i.createElement("br",null),i.createElement("input",{type:"range",min:t,max:r,step:null!=n?n:(r-t)/a,value:o,onChange:s.exports.useCallback((t=>{l(e,parseFloat(t.currentTarget.value))}),[l,e])}),i.createElement("br",null),i.createElement("input",{value:o.toFixed(2),onChange:s.exports.useCallback((n=>{l(e,Math.min(Math.max(parseFloat(n.currentTarget.value),t),r))}),[l,e,r,t])}))}const D={margin:8,padding:8,border:"solid 1px black"};function P({tremoloNode:e}){const[t,r]=s.exports.useState((()=>new Map(Array.from(e.parameters).map((([e,t])=>[e,t.value]))))),n=s.exports.useCallback(((t,n)=>{e.parameters.get(t).linearRampToValueAtTime(n,C.currentTime+.01),r((e=>{const r=new Map(e);return r.set(t,n),r}))}),[r,e.parameters]),a=s.exports.useMemo((()=>{const e=[];for(let r=0;r<200;r++)e.push(2*E(1,r,t.get("rate"),t.get("depth"),200)-1);return e}),[t]);return s.exports.useEffect((()=>{n("depth",0)}),[]),i.createElement("div",{style:D},"tremolo",Array.from(e.parameters).map((([e,r])=>i.createElement("div",{key:e},i.createElement(S,{name:e,min:r.minValue,max:r.maxValue,steps:200,value:t.get(e),onChange:n})))),i.createElement("div",{style:{padding:"8px 0"}},i.createElement(h,{width:200,height:100,data:a})))}function R({distortionNode:e}){const[t,r]=s.exports.useState({name:"linear",curve:p.linear()});return i.createElement("div",{style:D},i.createElement("label",null,"distortion",i.createElement("br",null),i.createElement("select",{style:{margin:"8px 0"},value:t.name,onChange:t=>{const n=t.currentTarget.value;e&&(e.curve=p[n]()),r({name:n,curve:e.curve})}},Object.keys(p).map((e=>i.createElement("option",{key:e,value:e},e))))),i.createElement("div",null,i.createElement(h,{width:200,height:100,data:t.curve})))}function A({name:e,initialValue:c,gainNode:u,min:m,max:p,step:d,persists:h}){const[f,g]=h?function(e,t){const r=`softrack-${e}`,[n,a]=s.exports.useState((()=>{try{const e=window.localStorage.getItem(r);return e?JSON.parse(e):t}catch(e){return console.log(e),t}}));return[n,e=>{try{const t=e instanceof Function?e(n):e;a(t),window.localStorage.setItem(r,JSON.stringify(t))}catch(t){console.log(t)}}]}(e,c):s.exports.useState(c);return s.exports.useEffect((()=>{u.gain.setValueAtTime(f,C.currentTime)}),[]),i.createElement(S,(v=((e,t)=>{for(var r in t||(t={}))a.call(t,r)&&l(e,r,t[r]);if(n)for(var r of n(t))o.call(t,r)&&l(e,r,t[r]);return e})({name:e},{min:m,max:p,step:d}),t(v,r({value:f,onChange:(e,t)=>{const r=t;u&&u.gain.linearRampToValueAtTime(r,C.currentTime+.01),g(r)}}))));var v}function k({reverbNode:e}){const[t,r]=s.exports.useState((()=>new Map(Object.entries(x.getParamDefaults()).map((([e,t])=>[e,t]))))),n=s.exports.useCallback(((t,n)=>{e.setNamedParam(t,n),r((e=>{const r=new Map(e);return r.set(t,n),r}))}),[r,e]);return s.exports.useEffect((()=>{n("Wet",0)}),[]),i.createElement("div",{style:D},"reverb",i.createElement("div",{className:"ReverbPanel_columns"},Object.keys(x.getParamDefaults()).map((e=>i.createElement("div",{key:e},i.createElement(S,{name:e,min:0,max:1,steps:100,value:t.get(e),onChange:n}))))))}function F({audioGraph:e}){const t=i.createElement("div",{style:D},i.createElement(A,{name:"input gain",initialValue:3===w?1:4,min:.1,max:20,step:.01,gainNode:e.pregain,persists:!1})),r=null==e.distortion?null:i.createElement(R,{distortionNode:e.distortion}),n=null==e.tremolo?null:i.createElement(P,{tremoloNode:e.tremolo}),a=null==e.reverb?null:i.createElement(k,{reverbNode:e.reverb}),o=i.createElement("div",{style:D},i.createElement(A,{name:"output gain",initialValue:1,min:.01,max:1.2,step:.01,gainNode:e.postgain,persists:!0}),i.createElement("div",{style:{margin:"8px 0"}},i.createElement(b,{audioContext:C,source:e.postgain,scale:1})));return i.createElement("div",{style:{display:"flex"}},t,r,n,a,o)}function I(){const[e,t]=s.exports.useState("/webaudio/assets/z.d1398b31.wav"),r=s.exports.useRef(null),n=s.exports.useRef(null),[a,o]=s.exports.useState(null);return s.exports.useEffect((()=>{r.current&&!n.current&&(n.current=M(r.current),o(n.current.reverb||n.current.tremolo||n.current.distortion||n.current.postgain))}),[]),i.createElement("div",null,i.createElement("div",{style:{display:"flex",flex:1}},i.createElement("div",{style:{padding:"8px 8px 4px 8px"}},i.createElement(d,{audioContext:C,source:a})),i.createElement("div",{style:D},"input",i.createElement("audio",{style:{display:"block",padding:8},controls:!0,autoPlay:!0,loop:!0,src:e,ref:r}),i.createElement("input",{style:{display:"block",padding:8},type:"file",onChange:e=>{const r=e.currentTarget.files[0];r&&t(URL.createObjectURL(r))}}))),n.current&&i.createElement(F,{audioGraph:n.current}))}function T(){const[e,t]=s.exports.useState("running"===C.state),[r,n]=s.exports.useState(!1);return s.exports.useEffect((()=>{Promise.all([x.load(C),f.load(C)]).then((()=>{n(!0)}))}),[]),i.createElement("div",null,e?r?i.createElement(I,null):"loading modules":i.createElement("button",{onClick:()=>{C.resume(),t(!0)}},"start"))}c.render(i.createElement(i.StrictMode,null,i.createElement(T,null)),document.getElementById("root"));
